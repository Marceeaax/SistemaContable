{% extends 'base.html' %}

{% block title %}Clientes RUC{% endblock %}

{% block content %}

<div class="content">
    <div class="container">
        <div class="row align-items-center">
            <div class="col-md-6">
                <h2 class="mb-4">Clientes RUC</h2>
            </div>
            <div class="col-md-6 text-right">
                <button type="button" class="btn btn-success" data-toggle="modal" data-target="#modalCrearCliente">
                    Añadir cliente
                  </button>
            </div>
        </div>
        <div class="table-responsive">
            <table class="table table-striped custom-table">
                <thead>
                    <tr>
                        <th scope="col">Nombres</th>
                        <th scope="col">Apellidos</th>
                        <th scope="col">RUC</th>
                        <th scope="col">Vencimiento</th>
                        <th scope="col">Contacto</th>
                        <th scope="col">Email</th>
                        <th scope="col">Tipo</th>
                    </tr>
                </thead>
                <tbody>
                    {% for persona in personas_fisicas %}
                    <tr class="table-row">
                        <td >{{ persona.nombre }}</td>
                        <td>{{ persona.apellido }}</td>
                        <td>{{ persona.ruc }}</td>
                        <td>{{ persona.vencimiento }}</td>
                        <td>{{ persona.telefono }}</td>
                        <td>{{ persona.email }}</td>
                        <td>Persona Física</td>
                        <td class="edit-cell">
                          <span class="material-symbols-outlined edit-icon">edit</span>
                        </td>
                    {% endfor %}
                    {% for persona in personas_juridicas %}
                    <tr>
                        <td>{{ persona.razon_social }}</td>
                        <td>{{ persona.representante_legal }}</td>
                        <td>{{ persona.ruc }}</td>
                        <td>{{ persona.telefono }}</td>
                        <td>{{ persona.email }}</td>
                        <td>Persona Jurídica</td>
                    </tr>
                  </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>

<!-- Modal -->
<div class="modal fade" id="modalCrearCliente" tabindex="-1" role="dialog" aria-labelledby="modalCrearClienteLabel" aria-hidden="true"  data-backdrop="static">
  <div class="modal-dialog" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="modalCrearClienteLabel">Nuevo Cliente</h5>
        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body">
        <div class="text-center">
          <div class="btn-group" role="group" aria-label="Tipo de Cliente">
            <button type="button" class="btn btn-persona-fisica active">Persona Física</button>
            <button type="button" class="btn btn-persona-juridica">Persona Jurídica</button>
          </div>
        </div>    
        <!-- Formulario de Persona Física -->
        <div id="personaFisicaForm">
          <form method="post" action="{% url 'clients:crear_cliente' %}" class="form">
            {% csrf_token %}
            {{ form_persona_fisica.as_p }}
            <div class="text-right">
              <button type="submit" name="form_type" value="fisica" class="btn btn-success btn-crear">Crear Persona Física</button>
            </div>
          </form>
        </div>
        
        <!-- Formulario de Persona Jurídica (oculto por defecto) -->
        <div id="personaJuridicaForm" style="display: none;">
          <form method="post" action="{% url 'clients:crear_cliente' %}" class="form">
            {% csrf_token %}
            {{ form_persona_juridica.as_p }}
            <input type="hidden" name="form_type" value="fisica">
            <div class="text-right">
              <button type="submit" name="form_type" value="juridica" class="btn btn-success">Crear Persona Jurídica</button>
            </div>
          </form>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Script para alternar entre formularios -->
<script>

document.addEventListener('DOMContentLoaded', function() {
    var btnFisica = document.querySelector('.btn-persona-fisica');
    var btnJuridica = document.querySelector('.btn-persona-juridica');
    var fisicaForm = document.getElementById('personaFisicaForm');
    var juridicaForm = document.getElementById('personaJuridicaForm');

    btnFisica.addEventListener('click', function() {
        fisicaForm.style.display = 'block';
        juridicaForm.style.display = 'none';
        btnFisica.classList.add('active');
        btnJuridica.classList.remove('active');
    });

    btnJuridica.addEventListener('click', function() {
        juridicaForm.style.display = 'block';
        fisicaForm.style.display = 'none';
        btnJuridica.classList.add('active');
        btnFisica.classList.remove('active');
    });
});
</script>


<script>
  jQuery(document).ready(function() {
      console.log('Documento listo');
      $('.btn-crear').on('click', function(e) {
          e.preventDefault();
          var form = $(this).closest('form');
          var form_type_value = $(this).attr('value'); 

          var formData = form.serialize() + '&form_type=' + form_type_value;

          $.ajax({
              type: 'POST',
              url: form.attr('action'),
              data: formData,
              dataType: 'json',
              success: function(response) {
                  if (response.success) {
                      Swal.fire({
                          title: "Éxito",
                          text: response.message,
                          icon: "success"
                      }).then(function() {
                          window.location.href = '/clients/clientesruc/';
                      });
                  }
              },
              error: function(xhr, status, err) {
                // Si el estado es 400, entonces es un error de validación.
                if (xhr.status === 400) {
                    var response = JSON.parse(xhr.responseText);
                    var errors = JSON.parse(response.errors);
                    var errorMessages = [];
                    for (var errorField in errors) {
                      // Comprobar si el campo de errores realmente existe en el objeto
                      if (errors.hasOwnProperty(errorField)) {
                          // Iterar sobre todos los mensajes de error para ese campo
                          for (var i = 0; i < errors[errorField].length; i++) {
                              errorMessages.push(errors[errorField][i].message);
                          }
                      }
                  }
                    Swal.fire({
                        title: "Error en el formulario",
                        text: errorMessages.join(', '),
                        icon: "error"
                    });
                } else {
                    // Para otros errores HTTP, mostrar un mensaje genérico.
                    Swal.fire({
                        title: "Error",
                        text: "Ocurrió un error inesperado: " + xhr.statusText,
                        icon: "error"
                    });
                }
            }
          });
      });
  });
</script>


  
<style>
  .form input, .form textarea {
      margin-bottom: 5px; /* Espacio debajo de cada campo */
      border: 1px solid #ddd; /* Borde más suave */
  }
  
  .form input[type="text"], .form input[type="email"], .form input[type="tel"], .form input[type="date"], .form textarea {
      width: 100%; /* Ancho completo */
      padding: 8px; /* Espaciado interno */
  }
  
  .form textarea {
      height: 80px; /* Altura fija para textareas */
  }

  .btn-crear {
    background-color: #28a745; /* Verde Bootstrap por defecto */
    color: white;
    border: none;
    padding: 10px 20px;
    font-size: 16px;
    border-radius: .25rem;
    transition: box-shadow 0.1s ease-in-out;
}

.btn-crear:hover {
    box-shadow: 0 0 10px rgba(40, 167, 69, 0.5); /* Sombra suave alrededor del botón */
    cursor: pointer;
}

.btn-group .btn {
    color: white;
    background-color: #6c757d; /* Gris por defecto */
    border: none;
    padding: 10px 20px;
    margin-bottom: 12px;
    margin-right: 10px;
}

/* Remueve el margen extra del último botón */
.button-group .btn:last-child {
  margin-right: 0;
}

.btn-group .btn.active {
    background-color: #007bff; /* Azul cuando está activo */
}

.btn-group .btn:not(.active):hover {
    background-color: #5a6268; /* Un gris un poco más oscuro para el hover */
}

.table-responsive {
    overflow-x: visible;
}

.table-row {
    position: relative; /* establecer posición relativa para las filas de la tabla */
  }


.edit-icon-container {
  position: absolute;
  right: -40px; /* O un valor adecuado para que el ícono aparezca fuera de la tabla */
  top: 50%;
  transform: translateY(-50%);
  cursor: pointer;
}

tr:hover + .edit-icon-container {
    display: block; /* Muestra el ícono cuando se hace hover en la fila de la tabla */
}

.edit-icon {
 /* ocultar por defecto */
    position: absolute;
    background-color: white;
    right: -10px; /* ajustar según sea necesario para mover hacia la derecha */
    top: 50%;
    cursor: pointer;
    font-variation-settings: 'FILL' 0, 'wght' 400, 'GRAD' 0, 'opsz' 24;
  }

.row-container {
  position: relative;
}

.row-container:hover .edit-icon-container {
  display: block;
}

.edit-icon-td {
  text-align: right;
  visibility: hidden;
  white-space: nowrap;
}

.table-row:hover .edit-cell {
    display: inline; /* mostrar el ícono al pasar el mouse */
  }


.edit-cell {
  background-color: white !important;
  visibility: hidden;
  width: 1%; /* Asegúrate de que esta celda no ocupe mucho espacio */
  white-space: nowrap; /* Evita que el contenido se ajuste en líneas */
  position: relative; /* Posición relativa para el posicionamiento del ícono de edición */
}


.table-row:hover .edit-cell {
  visibility: visible; /* Muestra la celda de edición cuando se hace hover en la fila */
  background-color: white ;
}

.table-striped tbody tr:hover td.edit-cell {
  background-color: white !important;
}

.table-striped tbody tr:hover td.edit-cell .edit-icon {
  background-color: white !important;
}
  </style>

{% endblock %}




